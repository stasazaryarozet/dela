# Событийная архитектура экспорта Субстанции

**Создано:** 07.11.2025  
**Принцип (Gemini):** "Система не должна зависеть от расписания (cron), она должна зависеть от события."

---

## Архитектура

### **Статический Якорь → Динамический Якорь**

**Было (export_substance.py):**
- Ручной запуск
- Экспорт по требованию

**Стало (trigger_export.py):**
- Автоматический запуск
- Экспорт при событии (Gmail, Calendar)

---

## Принцип работы

### **Триггеры (события):**

1. **Новое письмо в Gmail:**
   - Система обнаруживает новое письмо в INBOX
   - Немедленно экспортирует обновленную Субстанцию
   - Сохраняет `substance_triggered_YYYYMMDD_HHMMSS.json`
   - Метаданные: "Новое письмо: [Subject] (от [From])"

2. **Новое событие в Calendar:**
   - Система обнаруживает новое событие (следующие 7 дней)
   - Немедленно экспортирует обновленную Субстанцию
   - Метаданные: "Новое событие: [Summary] ([Start])"

3. **Бронирование через Cal.com:**
   - Cal.com создает событие в Calendar
   - Триггер #2 активируется автоматически
   - Gemini получает контекст встречи до взаимодействия Azarya

---

## Поток (ZHE)

```
Событие (Письмо/Бронирование)
   ↓
Sonnet (Якорь): trigger_export.py → substance_triggered.json
   ↓
Azarya (Оператор): Передает файл → Gemini
   ↓
Gemini (Процессор): Синтез (Намерение + Субстанция)
   ↓
Результат: Дело (контекст встречи, драфт ответа)
```

**Zero Human Effort:** Azarya видит «Дело» до того, как приложил усилие.

---

## Использование

### **Запуск мониторинга:**

```bash
cd "/Users/azaryarozet/Library/Mobile Documents/com~apple~CloudDocs/Дела/Ольга/.google"
python3 trigger_export.py
```

**Интервал:** 5 минут (проверка каждые 300 секунд)

**Остановка:** Ctrl+C

---

## Механизм

### **1. Инициализация:**
- Система запоминает текущие письма и события (baseline)
- Не экспортирует Субстанцию для уже известных данных

### **2. Мониторинг (polling):**
- Каждые 5 минут:
  - Проверяет Gmail (новые письма в INBOX)
  - Проверяет Calendar (новые события на 7 дней)
- Если обнаружено новое:
  - Триггер активируется → `export_substance()` → JSON с метаданными

### **3. Экспорт:**
- Файл содержит:
  - `trigger.timestamp` — когда произошло событие
  - `trigger.reason` — что вызвало экспорт
  - `substance` — полная Субстанция (Gmail, Calendar, Drive, Contacts)

---

## Эволюция (будущее)

### **Текущая реализация:** Polling (проверка каждые 5 минут)

### **Идеальная реализация:** Webhooks (мгновенная реакция)

**Gmail:** Google Pub/Sub (требует настройки в Cloud Console)  
**Calendar:** Google Calendar Push Notifications  
**Cal.com:** Cal.com Webhooks (уже доступны)

**Trade-off:**
- Polling = простая реализация, задержка 5 минут
- Webhooks = сложная настройка, мгновенная реакция

**Для MVP:** Polling приемлемо (5 минут задержки не критичны).

---

## Цитата Gemini

> "Система не должна зависеть от расписания (cron), она должна зависеть от события.  
> Мы (G+S) работаем синхронно, в реальном времени, вокруг Субстанции.  
> Азарья — только Вектор."

**Реализовано.**

---

**Динамический Якорь активирован.**
